<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C·ª≠a H√†ng C·ªßa Duong</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; }
        .container { width: 90%; max-width: 1200px; margin: 0 auto; }
        button { cursor: pointer; }
        .login-wrapper { display: grid; place-items: center; min-height: 90vh; }
        .login-container { background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        .login-container h2 { text-align: center; margin-top: 0; }
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .input-group input { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .login-container button { width: 100%; padding: 0.75rem; border: none; border-radius: 4px; background-color: #007bff; color: white; font-size: 1rem; }
        #message { text-align: center; margin-top: 1rem; font-size: 0.9rem; }
        .success { color: green; }
        .error { color: red; }
        .shop-wrapper, .admin-wrapper { display: none; }
        header { background-color: #fff; padding: 1rem 0; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 1000; }
        .nav-bar { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: bold; }
        .search-bar { width: 50%; }
        .search-bar input { width: 100%; padding: 0.5rem; border-radius: 5px; border: 1px solid #ccc; }
        .cart-icon { font-size: 1.2rem; cursor: pointer; position: relative; }
        #cart-count { background: #e74c3c; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.8rem; position: absolute; top: -10px; right: -10px; }
        .main-content { display: flex; margin-top: 1rem; }
        .sidebar { flex: 1; background: #fff; padding: 1rem; border-radius: 5px; margin-right: 1rem; height: fit-content; }
        .sidebar h3 { margin-top: 0; }
        .sidebar ul { list-style: none; padding: 0; }
        .sidebar li { padding: 0.5rem 0; cursor: pointer; border-bottom: 1px dashed #eee; }
        .sidebar li:hover, .sidebar li.active { color: #007bff; font-weight: bold; }
        .product-grid { flex: 3; }
        .product-section { background: #fff; padding: 1rem; border-radius: 5px; margin-bottom: 1rem; }
        .product-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .product-card { border: 1px solid #ddd; border-radius: 5px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; background: #fff; overflow: hidden;}
        .product-card img { width: 100%; height: 150px; object-fit: cover; }
        .product-card h4 { margin: 0.5rem 0; }
        .product-card p { color: #e74c3c; font-weight: bold; margin: 0.5rem 0; }
        .product-card button { background: #007bff; color: white; border: none; padding: 0.75rem 1rem; cursor: pointer; width: 100%; transition: background-color 0.2s; }
        .product-card button:disabled { background: #28a745; cursor: not-allowed; }
        .admin-panel-link, .logout-button { position: fixed; bottom: 20px; right: 20px; background: #2c3e50; color: white; padding: 1rem; border-radius: 5px; text-decoration: none; font-weight: bold; cursor: pointer; border: none; z-index: 1001; }
        .logout-button { right: 170px; background: #e74c3c; } 
        .cart-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); z-index: 2000; }
        .cart-drawer { position: fixed; top: 0; right: -400px; width: 100%; max-width: 400px; height: 100%; background-color: #fefefe; box-shadow: -2px 0 10px rgba(0,0,0,0.1); z-index: 2001; transition: right 0.3s ease-in-out; display: flex; flex-direction: column; }
        .cart-drawer.open { right: 0; }
        .cart-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #eee; }
        .cart-header h2 { margin: 0; }
        .close-button { font-size: 2rem; font-weight: bold; cursor: pointer; }
        #cartItemsList { flex-grow: 1; overflow-y: auto; padding: 1rem; }
        .cart-item { display: flex; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 1rem; }
        .cart-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 10px; }
        .cart-item-details { flex-grow: 1; }
        .cart-item-details h5 { margin: 0 0 5px 0; }
        .cart-item-details p { margin: 0; color: #e74c3c; }
        .cart-quantity-controls { display: flex; align-items: center; margin-top: 8px; }
        .quantity-btn { background: #eee; color: #333; border: 1px solid #ccc; width: 30px; height: 30px; border-radius: 50%; font-weight: bold; margin: 0; padding: 0; }
        .quantity-btn:hover { background: #ddd; }
        .cart-quantity-controls span { margin: 0 10px; font-weight: 500; }
        .cart-footer { padding: 1rem; border-top: 1px solid #eee; background: #fff; }
        .cart-total { text-align: right; font-size: 1.2rem; font-weight: bold; margin-bottom: 1rem; }
        #startCheckoutButton { width: 100%; background-color: #28a745; color: white; padding: 0.75rem; border: none; border-radius: 4px; font-size: 1rem; }
        #checkout-form { display: none; margin-top: 1.5rem; border-top: 1px solid #ccc; padding-top: 1rem; }
        #checkout-form .input-group { margin-bottom: 0.5rem; }
        #checkout-form button { width: 100%; background-color: #dc3545; }

        /* ----- 4. CSS CHO TRANG ADMIN ----- */
        .admin-wrapper { display: none; /* ·∫®n ban ƒë·∫ßu */ }
        .admin-container { padding: 2rem; max-width: 1400px; margin: 0 auto; }
        .admin-table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .admin-table th, .admin-table td { padding: 12px 15px; border-bottom: 1px solid #ddd; text-align: left; vertical-align: middle; }
        .admin-table th { background-color: #f4f7f6; }
        .admin-table select, .admin-table input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; min-width: 150px; }
        .admin-table button { background-color: #007bff; padding: 5px 10px; font-size: 0.9rem; margin-top: 0; }
        .admin-table button.update-btn:disabled { background-color: #ccc; }
        .status-Pending { color: #fd7e14; font-weight: bold; }
        .status-Confirmed { color: #007bff; font-weight: bold; }
        .status-Shipped { color: #28a745; font-weight: bold; }
        .status-Cancelled { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>

    <div class="login-wrapper" id="loginScreen">
        <div class="login-container">
            <form id="loginForm">
                <h2>ƒêƒÉng Nh·∫≠p</h2>
                <div class="input-group">
                    <label for="username">T√™n ƒëƒÉng nh·∫≠p</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="input-group">
                    <label for="password">M·∫≠t kh·∫©u</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit">ƒêƒÉng Nh·∫≠p</button>
                <p id="message"></p>
            </form>
        </div>
    </div>

    <div class="shop-wrapper" id="shopScreen">
        <header>
            <div class="container nav-bar">
                <div class="logo">Shop C·ªßa Duong</div>
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m...">
                </div>
                <div class="cart-icon" id="cartIcon">
                    üõí <span id="cart-count">0</span>
                </div>
            </div>
        </header>
        <div class="container main-content">
            <aside class="sidebar">
                <h3>Danh M·ª•c S·∫£n Ph·∫©m</h3>
                <ul id="categoryList"></ul>
            </aside>
            <main class="product-grid">
                <section class="product-section">
                    <h2>S·∫£n Ph·∫©m B√°n Ch·∫°y</h2>
                    <div class="product-list" id="bestsellerList"></div>
                </section>
                <section class="product-section">
                    <h2 id="productListTitle">T·∫•t C·∫£ S·∫£n Ph·∫©m</h2>
                    <div class="product-list" id="productList"></div>
                </section>
            </main>
        </div>
        <button class="admin-panel-link" id="adminPanelButton">ADMIN PANEL</button>
        <button class="logout-button" id="logoutButton">ƒêƒÉng xu·∫•t</button>
    </div>

    <div class="cart-overlay" id="cartOverlay"></div>
    <div class="cart-drawer" id="cartDrawer">
         <div class="cart-header">
            <h2>Gi·ªè H√†ng</h2>
            <span class="close-button" id="closeCartButton">&times;</span>
        </div>
        <div id="cartItemsList">
            <p>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</p>
        </div>
        <div class="cart-footer">
            <div class="cart-total" id="cartTotal">T·ªïng ti·ªÅn: 0ƒë</div>
            <button id="startCheckoutButton">
                Ti·∫øn h√†nh ƒê·∫∑t H√†ng
            </button>
            <form id="checkout-form">
                <h3>Th√¥ng tin giao h√†ng</h3>
                <div class="input-group">
                    <label for="customerName">H·ªç v√† t√™n</label>
                    <input type="text" id="customerName" required>
                </div>
                <div class="input-group">
                    <label for="customerPhone">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="tel" id="customerPhone" required>
                </div>
                <div class="input-group">
                    <label for="customerAddress">ƒê·ªãa ch·ªâ</label>
                    <input type="text" id="customerAddress" required>
                </div>
                <button type="submit">X√°c nh·∫≠n ƒê·∫∑t H√†ng</button>
            </form>
        </div>
    </div>

    <div class="admin-wrapper" id="adminScreen">
        <header>
            <div class="container nav-bar">
                <div class="logo">Admin Panel</div>
                <div>
                    <a href="http://localhost:3001" target="_blank" class="admin-panel-link" style="position: static; display: inline-block; margin-right: 15px;">
                        M·ªü GRAFANA
                    </a>
                    <button id="backToShopButton" style="background-color: #17a2b8;">Quay l·∫°i Shop</button>
                </div>
                <button class="logout-button" id="adminLogoutButton" style="position: static; margin-left: 15px;">ƒêƒÉng xu·∫•t</button>
            </div>
        </header>
        <div class="admin-container">
            <h2>Qu·∫£n l√Ω ƒê∆°n h√†ng</h2>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID ƒê∆°n</th>
                        <th>Kh√°ch h√†ng</th>
                        <th>ƒêi·ªán tho·∫°i</th>
                        <th>T·ªïng ti·ªÅn</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>M√£ COD</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="adminOrderList">
                    </tbody>
            </table>
        </div>
    </div>


    <script>
        // === BI·∫æN TO√ÄN C·ª§C (GLOBAL STATE) ===
        let ALL_PRODUCTS = [];
        let ALL_CATEGORIES = [{ id: 0, name: "T·∫•t c·∫£" }];
        let BESTSELLERS = [];
        let cart = []; 
        let userRole = null; 

        // === L·∫§Y C√ÅC PH·∫¶N T·ª¨ HTML (DOM ELEMENTS) ===
        const loginScreen = document.getElementById('loginScreen');
        const shopScreen = document.getElementById('shopScreen');
        const adminScreen = document.getElementById('adminScreen'); 
        
        const loginForm = document.getElementById('loginForm');
        const messageElement = document.getElementById('message');
        const logoutButton = document.getElementById('logoutButton');
        const adminLogoutButton = document.getElementById('adminLogoutButton'); 
        const adminPanelButton = document.getElementById('adminPanelButton'); 
        const backToShopButton = document.getElementById('backToShopButton'); 
        const adminOrderList = document.getElementById('adminOrderList'); 

        const searchInput = document.getElementById('searchInput');
        const categoryList = document.getElementById('categoryList');
        const productList = document.getElementById('productList');
        const bestsellerList = document.getElementById('bestsellerList');
        const productListTitle = document.getElementById('productListTitle');
        const cartIcon = document.getElementById('cartIcon');
        const cartCount = document.getElementById('cart-count');
        const cartDrawer = document.getElementById('cartDrawer');
        const cartOverlay = document.getElementById('cartOverlay');
        const closeCartButton = document.getElementById('closeCartButton');
        const cartItemsList = document.getElementById('cartItemsList');
        const cartTotal = document.getElementById('cartTotal');
        const startCheckoutButton = document.getElementById('startCheckoutButton');
        const checkoutForm = document.getElementById('checkout-form');

        // === C√ÅC H√ÄM X·ª¨ L√ù CH√çNH (LOGIC FUNCTIONS) ===

        // --- 1. H√ÄM HI·ªÇN TH·ªä (RENDER) ---
        function renderCategories() {
            categoryList.innerHTML = ''; 
            ALL_CATEGORIES.forEach(category => {
                const li = document.createElement('li');
                li.textContent = category.name;
                li.dataset.categoryId = category.id;
                if (category.id === 0) li.classList.add('active'); 
                categoryList.appendChild(li);
            });
        }
        function renderProducts(products, targetElement) {
            targetElement.innerHTML = '';
            if (products.length === 0) {
                targetElement.innerHTML = '<p>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o.</p>';
                return;
            }
            products.forEach(product => {
                const productHtml = `
                    <div class="product-card">
                        <img src="${product.image}" alt="${product.name}">
                        <h4>${product.name}</h4>
                        <p>${parseInt(product.price).toLocaleString('vi-VN')}ƒë</p>
                        <button class="add-to-cart-btn" data-product-id="${product.id}">Th√™m v√†o gi·ªè</button>
                    </div>
                `;
                targetElement.innerHTML += productHtml;
            });
        }
        function renderBestsellers() {
            renderProducts(BESTSELLERS, bestsellerList);
        }

        // --- 2. H√ÄM T·∫¢I D·ªÆ LI·ªÜU (FETCH API) ---
        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                const data = await response.json();
                ALL_CATEGORIES = [{ id: 0, name: "T·∫•t c·∫£" }, ...data];
            } catch (err) { console.error("L·ªói t·∫£i danh m·ª•c:", err); }
        }
        async function loadAllProducts() {
             try {
                const response = await fetch('/api/products');
                ALL_PRODUCTS = await response.json();
            } catch (err) { console.error("L·ªói t·∫£i s·∫£n ph·∫©m:", err); }
        }
        async function loadBestsellers() {
             try {
                const response = await fetch('/api/products/bestsellers');
                BESTSELLERS = await response.json();
            } catch (err) { console.error("L·ªói t·∫£i s·∫£n ph·∫©m b√°n ch·∫°y:", err); }
        }

        // --- 3. LOGIC L·ªåC ---
        function filterProducts() {
            const categoryId = parseInt(document.querySelector('#categoryList li.active').dataset.categoryId);
            const searchTerm = searchInput.value.toLowerCase();
            let filteredProducts = ALL_PRODUCTS;
            let filteredBestsellers = BESTSELLERS;
            if (categoryId !== 0) {
                filteredProducts = filteredProducts.filter(p => p.categoryId === categoryId);
                filteredBestsellers = filteredBestsellers.filter(p => p.categoryId === categoryId);
                productListTitle.textContent = `S·∫£n ph·∫©m: ${ALL_CATEGORIES.find(c => c.id === categoryId).name}`;
            } else {
                productListTitle.textContent = "T·∫•t C·∫£ S·∫£n Ph·∫©m";
            }
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(p => p.name.toLowerCase().includes(searchTerm));
                filteredBestsellers = filteredBestsellers.filter(p => p.name.toLowerCase().includes(searchTerm));
                productListTitle.textContent += ` (T√¨m: "${searchTerm}")`;
            }
            renderProducts(filteredProducts, productList);
            renderProducts(filteredBestsellers, bestsellerList);
        }
        
        // --- 4. LOGIC GI·ªé H√ÄNG (CART) ---
        function addToCart(productId, buttonElement) {
            const productToAdd = ALL_PRODUCTS.find(p => p.id === productId);
            if (!productToAdd) return;
            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ ...productToAdd, quantity: 1 });
            }
            updateCartDisplay();
            if (buttonElement) {
                const originalText = buttonElement.textContent;
                buttonElement.textContent = '‚úì ƒê√£ th√™m!';
                buttonElement.disabled = true;
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.disabled = false;
                }, 1500); 
            }
        }
        function updateCartQuantity(productId, newQuantity) {
            const item = cart.find(item => item.id === productId);
            if (!item) return;
            if (newQuantity <= 0) {
                cart = cart.filter(item => item.id !== productId);
            } else {
                item.quantity = newQuantity;
            }
            updateCartDisplay();
        }
        function calculateTotal() {
            return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
        }
        function updateCartDisplay() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;
            if (totalItems === 0) {
                cartItemsList.innerHTML = '<p>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</p>';
                startCheckoutButton.style.display = 'none';
                checkoutForm.style.display = 'none';
            } else {
                startCheckoutButton.style.display = 'block';
                cartItemsList.innerHTML = '';
                cart.forEach(item => {
                    const itemHtml = `
                        <div class="cart-item">
                            <img src="${item.image}" alt="${item.name}">
                            <div class="cart-item-details">
                                <h5>${item.name}</h5>
                                <p>${(item.price * item.quantity).toLocaleString('vi-VN')}ƒë</p>
                                <div class="cart-quantity-controls">
                                    <button class="quantity-btn" data-product-id="${item.id}" data-change="-1">-</button>
                                    <span>${item.quantity}</span>
                                    <button class="quantity-btn" data-product-id="${item.id}" data-change="1">+</button>
                                </div>
                            </div>
                        </div>
                    `;
                    cartItemsList.innerHTML += itemHtml;
                });
            }
            cartTotal.textContent = `T·ªïng ti·ªÅn: ${calculateTotal().toLocaleString('vi-VN')}ƒë`;
        }

// --- 5. LOGIC ƒê·∫∂T H√ÄNG (CHECKOUT) ---
async function handlePlaceOrder(event) {
    event.preventDefault();
    const token = localStorage.getItem('jwt_token');
    if (!token) {
        alert('Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n.'); showLogin(); return;
    }
    const orderDetails = {
        customerName: document.getElementById('customerName').value,
        customerPhone: document.getElementById('customerPhone').value,
        customerAddress: document.getElementById('customerAddress').value,
        items: cart, 
        total: calculateTotal()
    };
    try {
        const response = await fetch('/api/orders', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token 
            },
            body: JSON.stringify(orderDetails)
        });

        // --- ƒê√ÇY L√Ä PH·∫¶N S·ª¨A L·ªñI ---
        if (response.ok) {
            // CH·ªà khi response OK (200)
            alert('ƒê·∫∑t h√†ng th√†nh c√¥ng! ƒê∆°n h√†ng c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω.');
            cart = []; 
            updateCartDisplay();
            cartDrawer.classList.remove('open');
            cartOverlay.style.display = 'none';
        } else if (response.status === 401) {
             // N·∫øu l·ªói 401
             alert('Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n.'); 
             showLogin();
        } else {
            // C√°c l·ªói 500 kh√°c
            alert('C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t h√†ng (Server Error).');
        }
        // --- H·∫æT PH·∫¶N S·ª¨A L·ªñI ---

    } catch (err) {
         console.error("L·ªói ƒë·∫∑t h√†ng:", err);
         alert('L·ªói m·∫°ng, kh√¥ng th·ªÉ ƒë·∫∑t h√†ng.');
    }
}

        // --- 6. (M·ªöI) LOGIC ADMIN ---
        async function loadAdminOrders() {
            const token = localStorage.getItem('jwt_token');
            if (!token) {
                showLogin();
                return;
            }
            
            try {
                const response = await fetch('/api/admin/orders', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    if (response.status === 403) { 
                        alert(data.error || "B·∫°n kh√¥ng c√≥ quy·ªÅn Admin!");
                        showShop(); 
                    } else {
                        alert(data.error || "Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n.");
                        showLogin(); 
                    }
                    return;
                }
                
                const orders = await response.json();
                adminOrderList.innerHTML = ''; 
                if (orders.length === 0) {
                    adminOrderList.innerHTML = '<tr><td colspan="7">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o.</td></tr>';
                    return;
                }
                
                orders.forEach(order => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${order.id}</td>
                        <td>${order.customerName}</td>
                        <td>${order.customerPhone}</td>
                        <td>${parseInt(order.total).toLocaleString('vi-VN')}ƒë</td>
                        <td>
                            <select id="status-${order.id}" class="status-${order.status}">
                                <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Ch·ªù x√°c nh·∫≠n</option>
                                <option value="Confirmed" ${order.status === 'Confirmed' ? 'selected' : ''}>ƒê√£ x√°c nh·∫≠n</option>
                                <option value="Shipped" ${order.status === 'Shipped' ? 'selected' : ''}>ƒê√£ g·ª≠i</option>
                                <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>ƒê√£ h·ªßy</option>
                            </select>
                        </td>
                        <td><input type="text" id="cod-${order.id}" value="${order.cod_code || ''}" placeholder="Nh·∫≠p m√£ COD..."></td>
                        <td>
                            <button class="update-btn" data-order-id="${order.id}">C·∫≠p nh·∫≠t</button>
                        </td>
                    `;
                    adminOrderList.appendChild(tr);
                });

            } catch (err) {
                console.error("L·ªói t·∫£i ƒë∆°n h√†ng admin:", err);
                adminOrderList.innerHTML = `<tr><td colspan="7">L·ªói t·∫£i d·ªØ li·ªáu.</td></tr>`;
            }
        }
        
        async function handleUpdateOrder(orderId, buttonElement) {
            const token = localStorage.getItem('jwt_token');
            const status = document.getElementById(`status-${orderId}`).value;
            const cod_code = document.getElementById(`cod-${orderId}`).value;
            
            buttonElement.textContent = 'ƒêang...';
            buttonElement.disabled = true;

            try {
                const response = await fetch(`/api/admin/orders/${orderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ status, cod_code })
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'C·∫≠p nh·∫≠t th·∫•t b·∫°i');
                
                buttonElement.textContent = '‚úì ƒê√£ l∆∞u';
                setTimeout(() => {
                    buttonElement.textContent = 'C·∫≠p nh·∫≠t';
                    buttonElement.disabled = false;
                }, 2000);
                
                document.getElementById(`status-${orderId}`).className = `status-${status}`;

            } catch (err) {
                console.error("L·ªói c·∫≠p nh·∫≠t ƒë∆°n h√†ng:", err);
                alert("C·∫≠p nh·∫≠t th·∫•t b·∫°i: " + err.message);
                buttonElement.textContent = 'C·∫≠p nh·∫≠t';
                buttonElement.disabled = false;
            }
        }


        // === C√ÅC H√ÄM QU·∫¢N L√ù M√ÄN H√åNH ===
        async function initShop() {
            loginScreen.style.display = 'none';
            adminScreen.style.display = 'none';
            shopScreen.style.display = 'block';
            
            if (userRole === 'admin') {
                adminPanelButton.style.display = 'block';
            } else {
                adminPanelButton.style.display = 'none';
            }

            try {
                await Promise.all([
                    loadCategories(),
                    loadBestsellers(),
                    loadAllProducts()
                ]);
                renderCategories();
                renderBestsellers();
                renderProducts(ALL_PRODUCTS, productList); 
                updateCartDisplay(); 
            } catch (err) {
                console.error("L·ªói khi t·∫£i d·ªØ li·ªáu shop:", err);
                shopScreen.innerHTML = "<h1>L·ªói t·∫£i d·ªØ li·ªáu c·ª≠a h√†ng. Vui l√≤ng th·ª≠ l·∫°i.</h1>";
            }
        }
        
        function showLogin() {
            loginScreen.style.display = 'grid';
            shopScreen.style.display = 'none';
            adminScreen.style.display = 'none';
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('user_role');
            userRole = null;
        }
        
        function showAdminPanel() {
            loginScreen.style.display = 'none';
            shopScreen.style.display = 'none';
            adminScreen.style.display = 'block';
            loadAdminOrders(); 
        }

        // === G·∫ÆN C√ÅC B·ªò L·∫ÆNG NGHE S·ª∞ KI·ªÜN (EVENT LISTENERS) ===
        
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('jwt_token');
            userRole = localStorage.getItem('user_role'); 
            
            if (token && userRole) {
                console.log(`Ph√°t hi·ªán token, vai tr√≤: ${userRole}.`);
                initShop();
            } else {
                console.log('Kh√¥ng c√≥ token, hi·ªÉn th·ªã ƒëƒÉng nh·∫≠p.');
                showLogin();
            }
        });

        // ƒê√ÇY L√Ä H√ÄM QUAN TR·ªåNG NH·∫§T
        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault(); 
            messageElement.textContent = 'ƒêang ki·ªÉm tra...';
            const username = loginForm.username.value;
            const password = loginForm.password.value;
            try {
                // S·ª¨A: ƒê·∫£m b·∫£o g·ªçi /api/login
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                // KI·ªÇM TRA L·ªñI NGINX (n·∫øu nh·∫≠n v·ªÅ HTML)
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    console.error("L·ªói Nginx! Nh·∫≠n v·ªÅ HTML thay v√¨ JSON.");
                    messageElement.textContent = 'L·ªói c·∫•u h√¨nh Server (Nginx).';
                    return; 
                }

                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('jwt_token', data.token);
                    localStorage.setItem('user_role', data.user.role);
                    userRole = data.user.role; 
                    initShop(); 
                } else {
                    messageElement.textContent = data.error || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i.';
                }
            } catch (error) {
                console.log(error); // In ra l·ªói
                messageElement.textContent = 'L·ªói m·∫°ng. Vui l√≤ng th·ª≠ l·∫°i.';
            }
        });

        logoutButton.addEventListener('click', showLogin);
        adminLogoutButton.addEventListener('click', showLogin);
        adminPanelButton.addEventListener('click', showAdminPanel);
        backToShopButton.addEventListener('click', initShop);
        searchInput.addEventListener('keyup', filterProducts);
        categoryList.addEventListener('click', (event) => {
            if (event.target.tagName === 'LI') {
                document.querySelector('#categoryList li.active').classList.remove('active');
                event.target.classList.add('active');
                filterProducts();
            }
        });
        document.body.addEventListener('click', (event) => {
            if (event.target.classList.contains('add-to-cart-btn')) {
                const productId = parseInt(event.target.dataset.productId);
                addToCart(productId, event.target); 
            }
        });
        cartIcon.addEventListener('click', () => { 
            cartDrawer.classList.add('open');
            cartOverlay.style.display = 'block';
            checkoutForm.style.display = 'none';
        });
        closeCartButton.addEventListener('click', () => { 
            cartDrawer.classList.remove('open');
            cartOverlay.style.display = 'none';
        });
        cartOverlay.addEventListener('click', () => { 
            cartDrawer.classList.remove('open');
            cartOverlay.style.display = 'none';
        });
        cartItemsList.addEventListener('click', (event) => {
            if (event.target.classList.contains('quantity-btn')) {
                const productId = parseInt(event.target.dataset.productId);
                const change = parseInt(event.target.dataset.change);
                const item = cart.find(item => item.id === productId);
                if (item) {
                    const newQuantity = item.quantity + change;
                    updateCartQuantity(productId, newQuantity);
                }
            }
        });
        startCheckoutButton.addEventListener('click', () => {
            checkoutForm.style.display = 'block';
            startCheckoutButton.style.display = 'none';
        });
        checkoutForm.addEventListener('submit', handlePlaceOrder);
        adminOrderList.addEventListener('click', (event) => {
            if (event.target.classList.contains('update-btn')) {
                const orderId = parseInt(event.target.dataset.orderId);
                handleUpdateOrder(orderId, event.target);
            }
        });

    </script>
</body>
</html>